!function(){"use strict";console.log("BTIMPORT");const e="nazunacord",t={nazunacord:{baseUrl:"https://tachi.beerpsi.cc",clientId:"CI76714ce710c0a8f391154782c1dd2b3e6325a5be"}},o=t[e].baseUrl,n=t[e].clientId,r="api-key",c=["Past","Present","Future","Beyond","Eternal"],i=["LOST","CLEAR","FULL RECALL","PURE MEMORY","EASY CLEAR","HARD CLEAR"];let s=Date.now(),a=!1;function l(t){return localStorage.getItem(`__btimport__${t}_${e}`)}function p(){window.open(`${o}/client-file-flow/${n}`);document.querySelector(".box-content").insertAdjacentHTML("afterend",'\n    <div id="api-key-setup" style="background-color: #fff">\n        <form id="api-key-form">\n            <input type="text" id="api-key-form-key" placeholder="Copy API Key here"/>\n            <input type="submit" value="Save">\n        </form>\n    </div>\n    '),document.querySelector("#api-key-setup").addEventListener("submit",d)}function d(t){t.preventDefault();const o=document.querySelector("#api-key-form-key").value;var n,c;n=r,c=o,localStorage.setItem(`__btimport__${n}_${e}`,c.toString()),location.reload()}function u(){const e=document.querySelector(".box-content"),t=!!l(r),o=document.createElement("p");t||(o.append(document.createTextNode("You don't have an API key set up. Please set up an API key before proceeding.")),o.append(document.createElement("br")));let n=t?"Reconfigure API key (if broken)":"Set up API key";const c=document.createElement("a");c.id="setup-api-key-onclick",c.append(document.createTextNode(n)),c.onclick=p,o.append(c);const i=document.createElement("div");if(i.append(o),i.style="\n        color: white;\n        width: 100%;\n        background-color: rgba(51, 50, 62, .75);\n        text-align: center;\n    ",t){const e=document.createElement("a");e.id="bt-poll-button",e.onclick=m,e.innerText="- Start polling",i.append(e),i.append(document.createElement("br"));const t=document.createElement("a");t.id="bt-b30-button",t.onclick=h,t.innerText="- (REQUIRES ARCAEA ONLINE SUBSCRIPTION) Import best 30 scores",i.append(t)}i.id="bt-import",e.append(i)}async function m(){a=!0;const e=document.querySelector("#bt-poll-button");for(e.innerText="- Stop polling",e.onclick=()=>{f("Stopped polling."),e.onclick=m,e.innerText="Start polling",a=!1};a;){if(Date.now()-s==9e5){f("Script timed out. Stopped polling."),e.onclick=m,e.innerText="- Start polling",a=!1;break}const t=await fetch("https://webapi.lowiro.com/webapi/user/me").then((e=>e.json()));if(console.log(t),!t.success){f("Could not poll for most recent score. See the console for more details."),e.onclick=m,e.innerText="- Start polling",a=!1;break}await g(t.value.recent_score[0]),await new Promise((e=>setTimeout(e,9e4)))}}function f(e){let t=document.querySelector("#bt-import"),o=document.querySelector("#bt-import-status");o||(o=document.createElement("p"),o.id="bt-import-status",t.append(o)),o.innerText=e}async function y(e){const{scores:t=[]}=e;if(0===t.length)return void f("Nothing to import.");const n={meta:{game:"arcaea",playtype:"Touch",service:"bt-arcaea-site-poller"},scores:t},c=fetch(`${o}/ir/direct-manual/import`,{method:"POST",headers:{Authorization:"Bearer "+l(r),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(n)});f("Submitting scores...");b((await(await c).json()).body.url,t)}async function b(e,t){const o=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${l(r)}`}}),n=await o.json();if(n.success){if("ongoing"===n.body.importStatus)return f("Importing scores... "+n.description+" Progress: "+n.body.progress.description),void setTimeout(b,1e3,e);if("completed"!==n.body.importStatus)f(n.description);else{let e;if(console.log(n.body),1===t.length){let o=t[0];e=`${n.description}\n            - Song ID: ${o.identifier}\n            - Score: ${o.score}\n            - Lamp: ${o.lamp}\n            - Judgements: ${o.judgements.pure}-${o.judgements.far}-${o.judgements.lost}\n            - Time played: ${new Date(o.timeAchieved).toString()}\n            `}else e=`${n.description} ${n.body.import.scoreIDs.length} scores.`;if(n.body.import.errors.length>0){e+=`, ${n.body.import.errors.length} errors (see console log for details)`;for(const e of n.body.import.errors)console.log(`${e.type}: ${e.message}`)}f(e)}}else f("Terminal Error: "+n.description)}async function g(e){console.log(e);const{song_id:t,difficulty:o,score:n,shiny_perfect_count:r,perfect_count:a,near_count:l,miss_count:p,clear_type:d,time_played:u,health:m}=e,f={identifier:t,matchType:"inGameStrID",difficulty:c[o],score:n,lamp:i[d],judgements:{pure:a,far:l,lost:p},timeAchieved:u,optional:{shinyPure:r,gauge:m}};u>s&&(s=u,console.log(f),y({scores:[f]}))}async function h(e){const t=await fetch("https://webapi.lowiro.com/webapi/score/rating/me").then((e=>e.json()));if(console.log(t),!t.success)return void f(`Could not fetch best/recent rated scores: ${t.error_code}`);const o=[];for(const e of t.value.best_rated_scores.concat(t.value.recent_rated_scores)){const t={identifier:e.song_id,matchType:"inGameStrID",difficulty:c[e.difficulty],score:e.score,lamp:i[e.clear_type],judgements:{pure:e.perfect_count,far:e.near_count,lost:e.miss_count},timeAchieved:e.time_played,optional:{shinyPure:e.shiny_perfect_count}};o.push(t)}y({scores:o})}"undefined"!=typeof GM_fetch&&(fetch=GM_fetch),console.log("running");let S=document.querySelector(".banner.castle-banner");if(null===S){const _=document.getElementById("app"),k={childList:!0};function w(e,t){t.disconnect();for(const t of e)if("childList"===t.type&&(S=document.querySelector(".banner.castle-banner"),null!==S))switch(location.pathname){case"/en/profile/":case"/jp/profile/":u()}}new MutationObserver(w).observe(_,k)}else switch(location.pathname){case"/en/profile/":case"/jp/profile/":u()}}();
